// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// ===========================================
// MULTI-TENANT CORE
// ===========================================

model Organization {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  logoUrl      String?
  primaryColor String?
  createdAt    DateTime @default(now())

  // Relations
  users              User[]
  patients           Patient[]
  appointments       Appointment[]
  sales              Sale[]
  bankAccounts       BankAccount[]
  expenses           Expense[]
  providers          Provider[]
  inventoryItems     InventoryItem[]
  settings           Setting[]
  locations          Location[]
  chatMessages       ChatMessage[]
  tabataKnowledge    TabataKnowledge[]
  tabataFeedback     TabataFeedback[]
  auditLogs          AuditLog[]

  @@index([slug])
}

// ===========================================
// USER MANAGEMENT
// ===========================================

enum UserRole {
  admin
  secretary
  viewer
}

model User {
  id                String    @id @default(cuid())
  organizationId    String
  email             String    @unique
  passwordHash      String
  fullName          String
  role              UserRole  @default(viewer)
  isActive          Boolean   @default(true)
  resetToken        String?
  resetTokenExpires DateTime?
  lastLogin         DateTime?
  preferredColor    String?   @default("#6B9080")
  createdAt         DateTime  @default(now())

  // Relations
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesCreated       Sale[]              @relation("SaleCreatedBy")
  inventoryMovements InventoryMovement[] @relation("MovementCreatedBy")
  chatMessages       ChatMessage[]
  tabataFeedback     TabataFeedback[]
  // Soft delete relations
  patientsDeleted     Patient[]     @relation("PatientDeletedBy")
  appointmentsDeleted Appointment[] @relation("AppointmentDeletedBy")
  salesDeleted        Sale[]        @relation("SaleDeletedBy")
  expensesDeleted     Expense[]     @relation("ExpenseDeletedBy")
  // Audit relations
  auditLogs          AuditLog[]

  @@index([organizationId])
  @@index([email])
  @@index([resetToken])
}

// ===========================================
// PATIENT MANAGEMENT
// ===========================================

model Patient {
  id                   String    @id @default(cuid())
  organizationId       String
  patientCode          String    @unique
  fullName             String
  phone                String?
  whatsapp             String?
  email                String?
  notes                String?
  isActive             Boolean   @default(true)
  firstAppointmentDate DateTime?
  createdAt            DateTime  @default(now())
  // Soft delete
  deletedAt            DateTime?
  deletedById          String?

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  sales        Sale[]
  deletedBy    User?         @relation("PatientDeletedBy", fields: [deletedById], references: [id])

  @@index([organizationId])
  @@index([patientCode])
  @@index([organizationId, isActive])
  @@index([organizationId, fullName])
  @@index([organizationId, deletedAt])
}

// ===========================================
// APPOINTMENTS
// ===========================================

enum AppointmentType {
  presencial
  virtual
  terapia_choque
}

enum AppointmentStatus {
  confirmada
  no_responde
  cancelada
  reagendada
  completada
}

model Appointment {
  id              String            @id @default(cuid())
  organizationId  String
  patientId       String
  date            DateTime          @db.Date
  startTime       DateTime          @db.Time()
  endTime         DateTime          @db.Time()
  type            AppointmentType   @default(presencial)
  location        String?
  status          AppointmentStatus @default(confirmada)
  rescheduledToId String?           @unique
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  // Soft delete
  deletedAt       DateTime?
  deletedById     String?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patient         Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  rescheduledTo   Appointment? @relation("RescheduledAppointment", fields: [rescheduledToId], references: [id])
  rescheduledFrom Appointment? @relation("RescheduledAppointment")
  sales           Sale[]
  deletedBy       User?        @relation("AppointmentDeletedBy", fields: [deletedById], references: [id])

  @@index([organizationId])
  @@index([patientId])
  @@index([organizationId, date])
  @@index([organizationId, status])
  @@index([date, startTime])
  @@index([organizationId, deletedAt])
}

// ===========================================
// SALES & FINANCES
// ===========================================

enum PaymentMethod {
  efectivo
  transferencia
  otro
}

model Sale {
  id                   String        @id @default(cuid())
  organizationId       String
  patientId            String
  appointmentId        String?
  amount               Decimal       @db.Decimal(10, 2)
  paymentMethod        PaymentMethod @default(efectivo)
  paymentNote          String?
  bankAccountId        String?
  hasElectronicInvoice Boolean       @default(false)
  date                 DateTime      @db.Date
  createdById          String
  createdAt            DateTime      @default(now())
  // Soft delete
  deletedAt            DateTime?
  deletedById          String?

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patient      Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointment  Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  bankAccount  BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  createdBy    User         @relation("SaleCreatedBy", fields: [createdById], references: [id])
  deletedBy    User?        @relation("SaleDeletedBy", fields: [deletedById], references: [id])

  @@index([organizationId])
  @@index([organizationId, date])
  @@index([patientId])
  @@index([appointmentId])
  @@index([createdById])
  @@index([organizationId, deletedAt])
}

model BankAccount {
  id               String   @id @default(cuid())
  organizationId   String
  alias            String
  accountNumber    String?
  bankName         String?
  accountHolder    String?  // Nombre del titular
  accountHolderId  String?  // Cédula del titular
  accountType      String?  // Tipo de cuenta (Ahorros, Corriente)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sales        Sale[]

  @@index([organizationId])
  @@index([organizationId, isActive])
}

model Expense {
  id             String   @id @default(cuid())
  organizationId String
  description    String
  amount         Decimal  @db.Decimal(10, 2)
  category       String?
  date           DateTime @db.Date
  providerId     String?
  createdAt      DateTime @default(now())
  // Soft delete
  deletedAt      DateTime?
  deletedById    String?

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  provider     Provider?    @relation(fields: [providerId], references: [id], onDelete: SetNull)
  deletedBy    User?        @relation("ExpenseDeletedBy", fields: [deletedById], references: [id])

  @@index([organizationId])
  @@index([organizationId, date])
  @@index([organizationId, category])
  @@index([providerId])
  @@index([organizationId, deletedAt])
}

model Provider {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  contactName    String?
  phone          String?
  email          String?
  notes          String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  expenses     Expense[]

  @@index([organizationId])
  @@index([organizationId, isActive])
}

// ===========================================
// INVENTORY
// ===========================================

model InventoryItem {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  currentStock   Int      @default(0)
  minStock       Int      @default(0)
  unit           String?
  category       String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  movements    InventoryMovement[]

  @@index([organizationId])
  @@index([organizationId, isActive])
  @@index([organizationId, category])
}

enum MovementType {
  entrada
  salida
}

model InventoryMovement {
  id              String       @id @default(cuid())
  inventoryItemId String
  type            MovementType
  quantity        Int
  reason          String?
  createdById     String
  createdAt       DateTime     @default(now())

  // Relations
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  createdBy     User          @relation("MovementCreatedBy", fields: [createdById], references: [id])

  @@index([inventoryItemId])
  @@index([createdById])
  @@index([inventoryItemId, createdAt])
}

// ===========================================
// SETTINGS
// ===========================================

model Setting {
  id             String @id @default(cuid())
  organizationId String
  key            String
  value          String

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, key])
  @@index([organizationId])
}

model Location {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  address        String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, isActive])
}

// ===========================================
// TABATA AI ASSISTANT
// ===========================================

model ChatMessage {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  role           String   // user, assistant
  content        String   @db.Text
  createdAt      DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([userId])
}

model TabataKnowledge {
  id             String    @id @default(cuid())
  organizationId String
  category       String    // paciente, proceso, preferencia, regla
  content        String    @db.Text
  source         String?   // cómo lo aprendió
  createdAt      DateTime  @default(now())
  expiresAt      DateTime?

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, category])
}

model TabataFeedback {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  type           String   // bug, mejora, deseo, confusion
  description    String   @db.Text
  context        String?  @db.Text
  status         String   @default("pendiente") // pendiente, revisado, implementado
  createdAt      DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([organizationId, type])
  @@index([userId])
}

// ===========================================
// AUDIT LOG
// ===========================================

model AuditLog {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  action         String   // CREATE, UPDATE, DELETE, RESTORE
  entity         String   // Patient, Sale, Appointment, Expense
  entityId       String
  oldData        Json?    // datos antes del cambio
  newData        Json?    // datos después del cambio
  createdAt      DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([entity, entityId])
  @@index([userId])
}
